---
title: Tutorial for microbiome analysis in R
author: Yan Hui
date: '2021-01-01'
tags:
  - Microbiome
  - R
slug: Microbiome-R
draft: no
description: Introduction to microbiome analysis.
output:
   blogdown::html_page:
     toc: true
     fig_width: 8
     highlight: "pygments"
     dev: "png"
---

<script src="index_files/accessible-code-block/empty-anchor.js"></script>
<script src="index_files/clipboard/clipboard.min.js"></script>
<link href="index_files/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
<script src="index_files/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
<script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-clipboard\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"<i class=\"fa fa-times-circle\" style=\"color: #F94144\"><\/i>"})</script>
<link href="index_files/font-awesome/css/all.css" rel="stylesheet" />
<link href="index_files/font-awesome/css/v4-shims.css" rel="stylesheet" />
<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>
<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<div id="TOC">
<ul>
<li><a href="#what-you-will-work-on">What you will work on</a></li>
<li><a href="#preparation">Preparation</a></li>
<li><a href="#build-phyloseq-project">Build phyloseq project</a></li>
<li><a href="#check-the-sequencing-depth-with-rarefaction-curve">Check the sequencing depth with rarefaction curve</a></li>
<li><a href="#alpha-diversity">Alpha diversity</a></li>
<li><a href="#beta-diversity">Beta diversity</a></li>
<li><a href="#abundance-bar-plot">Abundance bar plot</a></li>
<li><a href="#differential-abundance-analysis">Differential abundance analysis</a><ul>
<li><a href="#deseq2">DESeq2</a></li>
<li><a href="#ancom-bc">ANCOM-BC</a></li>
</ul></li>
</ul>
</div>

<p><strong>BEFORE YOU START:</strong> This is a <em>minimal tutorial</em> to visualize microbiome result with R. The tutorial starts from the processed output from metagenomic sequencing, e.g. feature matrix. It’s suitable for someone who wants to try a hand-on analysis, especially for <strong>R users</strong>, helping you understand the basic concepts of microbiome outputs. This tutorial will only give inspirations for some common analysis (alpha/beta diversity, differential abundance analysis)， but it shall be adequate if you only consider microbiome as a sub-story.</p>
<ul>
<li>The demo data-set comes from the <a href="https://qiime2.org/">QIIME 2</a> tutorial - <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving Pictures</a>.</li>
<li>This is a <strong>beginner tutorial</strong>. You still have time to run away if you’re an experienced bioinformatician. 👻</li>
</ul>
<div id="what-you-will-work-on" class="section level2">
<h2>What you will work on</h2>
<p>After sequencing, you will get some (<a href="https://en.wikipedia.org/wiki/FASTQ_format">fastq</a>/<a href="https://nanoporetech.com/nanopore-sequencing-data-analysis">fast5</a>/<a href="http://files.pacb.com/software/instrument/2.0.0/bas.h5%20Reference%20Guide.pdf">h5</a>) files from the sequencing. These files contain the base information e.g. read quality. If the sequenced sample is a mixed community, i.e. metagenomics, you need to identify where the reads come from (specific species and samples). There are plenty of strategies for metagenomics such as amplicon and shotgun sequencing. But they give more or less similar <em>structural profiles</em>:</p>
<ul>
<li>Feature table (Necessary), a matrix containing the abundances of detected microbial features(OTUs, ASVs, microbial markers)</li>
<li>Taxonomy table (Optional), an array indicating the taxonomy of the features, which can be integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>.</li>
<li>Phylogenetic tree (Optional), a phylogenetic tree indicating the similarity of microbial features, potentially used when calculating phylogentic diversity metrics (optionally integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>).</li>
<li>Metadata, a matrix containing the infomation for analysis (optionally integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>).</li>
</ul>
</div>
<div id="preparation" class="section level2">
<h2>Preparation</h2>
<p><strong>Start with QIIME 2 output</strong> Here QIIME 2 data is adopted as an example. If you don’t have QIIME 2 output, if can skip the <code>bash code</code> for <code>QIIME 2</code> below. All data is imported using R built-ins, but QIIME 2 need extra steps outside R. QIIME 2 data file is defined as <a href="https://docs.qiime2.org/2020.11/concepts/">qza</a> format , which is actually just <em>zipped</em> file. Below are data from the <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving Pictures</a> in QIIME 2.</p>
<pre><code>## rooted-tree.qza
## sample-metadata.tsv
## table.qza
## taxonomy.qza</code></pre>
<p>As the R buildins didn’t accept .qza or .biom files, here I give a example to transform these qza files to a R-like format. You need QIIME 2 (qiime2-2020.11) installed.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">conda</span> activate qiime2-2020.11</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">for</span> <span class="ex">i</span> in *.qza<span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ex">qiime</span> tools export --input-path <span class="va">$i</span> --output-path .</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">done</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="ex">biom</span> convert -i feature-table.biom -o feature-table.tsv --to-tsv</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="ex">conda</span> deactivate</span></code></pre></div>
<p>And you will have</p>
<pre><code>## feature-table.tsv
## sample-metadata.tsv
## taxonomy.tsv
## tree.nwk</code></pre>
<p>Install and load relevant packages: <a href="https://github.com/joey711/phyloseq">phyloseq</a>, <a href="https://ggplot2.tidyverse.org/">tidyverse</a>, <a href="https://cran.r-project.org/web/packages/vegan/index.html">vegan</a>, <a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html">DESeq2</a> , <a href="http://www.bioconductor.org/packages/release/bioc/html/ANCOMBC.html">ANCOMBC</a>, <a href="https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html">ComplexHeatmap</a>. You can copy the code below.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>p1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;vegan&quot;</span>, <span class="st">&quot;BiocManager&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>p2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;phyloseq&quot;</span>, <span class="st">&quot;ANCOMBC&quot;</span>, <span class="st">&quot;DESeq2&quot;</span>, <span class="st">&quot;ComplexHeatmap&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>load_package &lt;-<span class="st"> </span><span class="cf">function</span>(p) {</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">requireNamespace</span>(p, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)) {</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="kw">ifelse</span>(p <span class="op">%in%</span><span class="st"> </span>p1, </span>
<span id="cb4-6"><a href="#cb4-6"></a>           <span class="kw">install.packages</span>(p, <span class="dt">repos =</span> <span class="st">&quot;http://cran.us.r-project.org/&quot;</span>), </span>
<span id="cb4-7"><a href="#cb4-7"></a>           BiocManager<span class="op">::</span><span class="kw">install</span>(p))</span>
<span id="cb4-8"><a href="#cb4-8"></a>  }</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="kw">library</span>(p, <span class="dt">character.only =</span> <span class="ot">TRUE</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-10"><a href="#cb4-10"></a>}</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">invisible</span>(<span class="kw">lapply</span>(<span class="kw">c</span>(p1,p2), load_package))</span></code></pre></div>
</div>
<div id="build-phyloseq-project" class="section level2">
<h2>Build phyloseq project</h2>
<p>Load data to build a phyloseq project, phyloseq description is <a href="https://joey711.github.io/phyloseq/import-data.html">here</a>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>otu &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;feature-table.tsv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">header =</span> T, <span class="dt">row.names =</span> <span class="dv">1</span>, </span>
<span id="cb5-2"><a href="#cb5-2"></a>                  <span class="dt">skip =</span> <span class="dv">1</span>, <span class="dt">comment.char =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a>taxonomy &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;taxonomy.tsv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">header =</span> T ,<span class="dt">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co"># clean the taxonomy, Greengenes format</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>tax &lt;-<span class="st"> </span>taxonomy <span class="op">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="st">  </span><span class="kw">select</span>(Taxon) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="st">  </span><span class="kw">separate</span>(Taxon, <span class="kw">c</span>(<span class="st">&quot;Kingdom&quot;</span>, <span class="st">&quot;Phylum&quot;</span>, <span class="st">&quot;Class&quot;</span>, <span class="st">&quot;Order&quot;</span>, <span class="st">&quot;Family&quot;</span>, <span class="st">&quot;Genus&quot;</span>, <span class="st">&quot;Species&quot;</span>), <span class="st">&quot;; &quot;</span>)</span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a>tax.clean &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">row.names =</span> <span class="kw">row.names</span>(tax),</span>
<span id="cb5-11"><a href="#cb5-11"></a>                        <span class="dt">Kingdom =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">1</span>], <span class="st">&quot;k__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-12"><a href="#cb5-12"></a>                        <span class="dt">Phylum =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">2</span>], <span class="st">&quot;p__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-13"><a href="#cb5-13"></a>                        <span class="dt">Class =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">3</span>], <span class="st">&quot;c__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-14"><a href="#cb5-14"></a>                        <span class="dt">Order =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">4</span>], <span class="st">&quot;o__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-15"><a href="#cb5-15"></a>                        <span class="dt">Family =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">5</span>], <span class="st">&quot;f__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-16"><a href="#cb5-16"></a>                        <span class="dt">Genus =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">6</span>], <span class="st">&quot;g__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-17"><a href="#cb5-17"></a>                        <span class="dt">Species =</span> <span class="kw">str_replace</span>(tax[,<span class="dv">7</span>], <span class="st">&quot;s__&quot;</span>,<span class="st">&quot;&quot;</span>),</span>
<span id="cb5-18"><a href="#cb5-18"></a>                        <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a>tax.clean[<span class="kw">is.na</span>(tax.clean)] &lt;-<span class="st"> &quot;&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>tax.clean[tax.clean<span class="op">==</span><span class="st">&quot;__&quot;</span>] &lt;-<span class="st"> &quot;&quot;</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(tax.clean)){</span>
<span id="cb5-24"><a href="#cb5-24"></a>  <span class="cf">if</span> (tax.clean[i,<span class="dv">7</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-25"><a href="#cb5-25"></a>    tax.clean<span class="op">$</span>Species[i] &lt;-<span class="st"> </span><span class="kw">paste</span>(tax.clean<span class="op">$</span>Genus[i], tax.clean<span class="op">$</span>Species[i], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-26"><a href="#cb5-26"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">2</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-27"><a href="#cb5-27"></a>    kingdom &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified&quot;</span>, tax.clean[i,<span class="dv">1</span>], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-28"><a href="#cb5-28"></a>    tax.clean[i, <span class="dv">2</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span>kingdom</span>
<span id="cb5-29"><a href="#cb5-29"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">3</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-30"><a href="#cb5-30"></a>    phylum &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified&quot;</span>, tax.clean[i,<span class="dv">2</span>], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-31"><a href="#cb5-31"></a>    tax.clean[i, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span>phylum</span>
<span id="cb5-32"><a href="#cb5-32"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">4</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-33"><a href="#cb5-33"></a>    class &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified&quot;</span>, tax.clean[i,<span class="dv">3</span>], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-34"><a href="#cb5-34"></a>    tax.clean[i, <span class="dv">4</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span>class</span>
<span id="cb5-35"><a href="#cb5-35"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">5</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-36"><a href="#cb5-36"></a>    order &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified&quot;</span>, tax.clean[i,<span class="dv">4</span>], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-37"><a href="#cb5-37"></a>    tax.clean[i, <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span>order</span>
<span id="cb5-38"><a href="#cb5-38"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">6</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-39"><a href="#cb5-39"></a>    family &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified&quot;</span>, tax.clean[i,<span class="dv">5</span>], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-40"><a href="#cb5-40"></a>    tax.clean[i, <span class="dv">6</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span>family</span>
<span id="cb5-41"><a href="#cb5-41"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tax.clean[i,<span class="dv">7</span>] <span class="op">==</span><span class="st"> &quot;&quot;</span>){</span>
<span id="cb5-42"><a href="#cb5-42"></a>    tax.clean<span class="op">$</span>Species[i] &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Unclassified &quot;</span>,tax.clean<span class="op">$</span>Genus[i], <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb5-43"><a href="#cb5-43"></a>  }</span>
<span id="cb5-44"><a href="#cb5-44"></a>}</span>
<span id="cb5-45"><a href="#cb5-45"></a></span>
<span id="cb5-46"><a href="#cb5-46"></a>metadata &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;sample-metadata.tsv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">header =</span> T, <span class="dt">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb5-47"><a href="#cb5-47"></a>OTU =<span class="st"> </span><span class="kw">otu_table</span>(<span class="kw">as.matrix</span>(otu), <span class="dt">taxa_are_rows =</span> <span class="ot">TRUE</span>)</span>
<span id="cb5-48"><a href="#cb5-48"></a>TAX =<span class="st"> </span><span class="kw">tax_table</span>(<span class="kw">as.matrix</span>(tax.clean))</span>
<span id="cb5-49"><a href="#cb5-49"></a>SAMPLE &lt;-<span class="st"> </span><span class="kw">sample_data</span>(metadata)</span>
<span id="cb5-50"><a href="#cb5-50"></a>TREE =<span class="st"> </span><span class="kw">read_tree</span>(<span class="st">&quot;tree.nwk&quot;</span>)</span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="co"># merge the data</span></span>
<span id="cb5-52"><a href="#cb5-52"></a>ps &lt;-<span class="st"> </span><span class="kw">phyloseq</span>(OTU, TAX, SAMPLE,TREE)</span></code></pre></div>
<p>The phyloseq project looks like</p>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 770 taxa and 34 samples ]
## sample_data() Sample Data:       [ 34 samples by 8 sample variables ]
## tax_table()   Taxonomy Table:    [ 770 taxa by 7 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 770 tips and 768 internal nodes ]</code></pre>
</div>
<div id="check-the-sequencing-depth-with-rarefaction-curve" class="section level2">
<h2>Check the sequencing depth with rarefaction curve</h2>
<p><img src="index_files/figure-html/rarefaction-1.png" width="768" /></p>
<p>The sequencing depth is 4523.735 ± 2933.477 (mean ± SD), ranging from 897 to 9820.</p>
<p>As we could see, a sequencing depth of 1000 has captured most taxonomic tags. To minimize the bias from varying sequenicng depth, it’s recommended to do a rarefaction before calculating diversity metrics. However, it’s <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003531">not always the rule of thumb</a>. To keep consistence with the <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving pictures tutorial</a>, we rarefy (resample) all samples to the sequencing depth of 1103. (As it’s random sampling process, the result is unlikely to be identical as the <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving pictures tutorial</a>)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">set.seed</span>(<span class="dv">111</span>) <span class="co"># keep result reproductive</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>ps.rarefied =<span class="st"> </span><span class="kw">rarefy_even_depth</span>(ps, <span class="dt">rngseed=</span><span class="dv">1</span>, <span class="dt">sample.size=</span><span class="dv">1103</span>, <span class="dt">replace=</span>F)</span></code></pre></div>
<p>After rarefaction, the phyloseq looks like</p>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 666 taxa and 31 samples ]
## sample_data() Sample Data:       [ 31 samples by 8 sample variables ]
## tax_table()   Taxonomy Table:    [ 666 taxa by 7 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 666 tips and 664 internal nodes ]</code></pre>
<p>The sequencing depth of all remaining 31 samples is 1103.</p>
</div>
<div id="alpha-diversity" class="section level2">
<h2>Alpha diversity</h2>
<p>Alpha diversity metrics assess the species diversity within the ecosystems, telling you how diverse a sequenced community is.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">plot_richness</span>(ps.rarefied, <span class="dt">x=</span><span class="st">&quot;body.site&quot;</span>, <span class="dt">measures=</span><span class="kw">c</span>(<span class="st">&quot;Observed&quot;</span>, <span class="st">&quot;Shannon&quot;</span>)) <span class="op">+</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.background =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x.bottom =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">-90</span>))</span></code></pre></div>
<p><img src="index_files/figure-html/alpha_diversity-1.png" width="768" /></p>
<p>We could see tongue samples had the lowest alpha diversity. Next, some statistics: pairwise test with Wilcoxon rank-sum test, corrected by FDR method. For the number of observed tags,</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>rich =<span class="st"> </span><span class="kw">estimate_richness</span>(ps.rarefied, <span class="dt">measures =</span> <span class="kw">c</span>(<span class="st">&quot;Observed&quot;</span>, <span class="st">&quot;Shannon&quot;</span>))</span>
<span id="cb10-2"><a href="#cb10-2"></a>wilcox.observed &lt;-<span class="st"> </span><span class="kw">pairwise.wilcox.test</span>(rich<span class="op">$</span>Observed, </span>
<span id="cb10-3"><a href="#cb10-3"></a>                                        <span class="kw">sample_data</span>(ps.rarefied)<span class="op">$</span>body.site, </span>
<span id="cb10-4"><a href="#cb10-4"></a>                                        <span class="dt">p.adjust.method =</span> <span class="st">&quot;BH&quot;</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a>tab.observed &lt;-<span class="st"> </span>wilcox.observed<span class="op">$</span>p.value <span class="op">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="st">  </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;group1&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key=</span><span class="st">&quot;group2&quot;</span>, <span class="dt">value=</span><span class="st">&quot;p.adj&quot;</span>, <span class="op">-</span>group1) <span class="op">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="st">  </span><span class="kw">na.omit</span>()</span>
<span id="cb10-10"><a href="#cb10-10"></a>tab.observed</span></code></pre></div>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["left palm","right palm","tongue","right palm","tongue","tongue"],["gut","gut","gut","left palm","left palm","right palm"],[0.309861519622914,1,0.0026441634012951,1,0.0026441634012951,0.0157960566577091]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>group1<\/th>\n      <th>group2<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Similarly for Shannon diversity,</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>wilcox.shannon &lt;-<span class="st"> </span><span class="kw">pairwise.wilcox.test</span>(rich<span class="op">$</span>Shannon, </span>
<span id="cb11-2"><a href="#cb11-2"></a>                                       <span class="kw">sample_data</span>(ps.rarefied)<span class="op">$</span>body.site, </span>
<span id="cb11-3"><a href="#cb11-3"></a>                                       <span class="dt">p.adjust.method =</span> <span class="st">&quot;BH&quot;</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a>tab.shannon &lt;-<span class="st"> </span>wilcox.shannon<span class="op">$</span>p.value <span class="op">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">  </span>tibble<span class="op">::</span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;group1&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key=</span><span class="st">&quot;group2&quot;</span>, <span class="dt">value=</span><span class="st">&quot;p.adj&quot;</span>, <span class="op">-</span>group1) <span class="op">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">  </span><span class="kw">na.omit</span>()</span>
<span id="cb11-9"><a href="#cb11-9"></a>tab.shannon</span></code></pre></div>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["left palm","right palm","tongue","right palm","tongue","tongue"],["gut","gut","gut","left palm","left palm","right palm"],[0.0748251748251748,0.17022977022977,0.0719045660222131,0.851814851814852,0.000987248046071575,0.00839160839160839]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>group1<\/th>\n      <th>group2<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="beta-diversity" class="section level2">
<h2>Beta diversity</h2>
<p>Beta diversity assesses the dissimilarity between ecosystem, telling you to what extend one community is different from another. Here are some demo code using Bray Curtis and binary Jaccard distance. I personally do not recommend direct use of the UniFrac metrics supported by phyloseq, especially when your tree is not dichotomous. This will happen when some children branches lose their parents during rarefaction 😭. You need to re-root your tree in e.g. QIIME 2 if you run into this case, see <a href="https://github.com/joey711/phyloseq/issues/936">here</a>. Besides, the UniFrac calculation by phyloseq has not been checked with the source code, see the posts in <a href="https://github.com/joey711/phyloseq/issues/956">phyloseq issues</a> and <a href="https://forum.qiime2.org/t/very-different-weighted-unifrac-results-for-qiime2-versus-phyloseq/4591">QIIME 2 forum</a>. So it’s safer to use QIIME 2 version for now given that both QIIME and UniFrac concept came from the <a href="https://knightlab.ucsd.edu/">Knight lab</a>.</p>
<div id="pcoa-and-permanovaadonis" class="section level4">
<h4><a href="https://mb3is.megx.net/gustame/dissimilarity-based-methods/principal-coordinates-analysis">PCoA</a> and <a href="https://mb3is.megx.net/gustame/hypothesis-tests/manova/npmanova">PERMANOVA/ADONIS</a></h4>
<ul>
<li><em>Bray curtis</em></li>
</ul>
<p><code>distance</code> is in overlapped use, so we specify the package by <code>phyloseq::distance</code></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>dist =<span class="st"> </span>phyloseq<span class="op">::</span><span class="kw">distance</span>(ps.rarefied, <span class="dt">method=</span><span class="st">&quot;bray&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a>ordination =<span class="st"> </span><span class="kw">ordinate</span>(ps.rarefied, <span class="dt">method=</span><span class="st">&quot;PCoA&quot;</span>, <span class="dt">distance=</span>dist)</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">plot_ordination</span>(ps.rarefied, ordination, <span class="dt">color=</span><span class="st">&quot;body.site&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.background =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="index_files/figure-html/pcoa_bray-1.png" width="768" /></p>
<p><em>PERMANOVA/ADONIS</em></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>metadata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.rarefied))</span>
<span id="cb13-2"><a href="#cb13-2"></a>test.adonis &lt;-<span class="st"> </span><span class="kw">adonis</span>(dist <span class="op">~</span><span class="st"> </span>body.site, <span class="dt">data =</span> metadata)</span>
<span id="cb13-3"><a href="#cb13-3"></a>test.adonis &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(test.adonis<span class="op">$</span>aov.tab)</span>
<span id="cb13-4"><a href="#cb13-4"></a>test.adonis</span></code></pre></div>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["body.site","Residuals","Total"],[3,27,30],[5.21390787395429,5.88330179759205,11.0972096715463],[1.7379692913181,0.217900066577483,null],[7.97599247497289,null,null],[0.469839538791715,0.530160461208285,1],[0.001,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Df<\/th>\n      <th>SumsOfSqs<\/th>\n      <th>MeanSqs<\/th>\n      <th>F.Model<\/th>\n      <th>R2<\/th>\n      <th>Pr(&gt;F)<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><em>PAIRWISE PERMANOVA</em></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>cbn &lt;-<span class="st"> </span><span class="kw">combn</span>(<span class="dt">x=</span><span class="kw">unique</span>(metadata<span class="op">$</span>body.site), <span class="dt">m =</span> <span class="dv">2</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a>p &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(cbn)){</span>
<span id="cb14-5"><a href="#cb14-5"></a>ps.subs &lt;-<span class="st"> </span><span class="kw">subset_samples</span>(ps.rarefied, body.site <span class="op">%in%</span><span class="st"> </span>cbn[,i])</span>
<span id="cb14-6"><a href="#cb14-6"></a>metadata_sub &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.subs))</span>
<span id="cb14-7"><a href="#cb14-7"></a>permanova_pairwise &lt;-<span class="st"> </span><span class="kw">adonis</span>(phyloseq<span class="op">::</span><span class="kw">distance</span>(ps.subs, <span class="dt">method =</span> <span class="st">&quot;bray&quot;</span>) <span class="op">~</span><span class="st"> </span>body.site, </span>
<span id="cb14-8"><a href="#cb14-8"></a>                             <span class="dt">data =</span> metadata_sub)</span>
<span id="cb14-9"><a href="#cb14-9"></a>p &lt;-<span class="st"> </span><span class="kw">c</span>(p, permanova_pairwise<span class="op">$</span>aov.tab<span class="op">$</span><span class="st">`</span><span class="dt">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>])</span>
<span id="cb14-10"><a href="#cb14-10"></a>}</span>
<span id="cb14-11"><a href="#cb14-11"></a></span>
<span id="cb14-12"><a href="#cb14-12"></a>p.adj &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(p, <span class="dt">method =</span> <span class="st">&quot;BH&quot;</span>)</span>
<span id="cb14-13"><a href="#cb14-13"></a>p.table &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(<span class="kw">t</span>(cbn), <span class="dt">p=</span>p, <span class="dt">p.adj=</span>p.adj)</span>
<span id="cb14-14"><a href="#cb14-14"></a>p.table</span></code></pre></div>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["gut","gut","gut","left palm","left palm","right palm"],["left palm","right palm","tongue","right palm","tongue","tongue"],[0.001,0.003,0.001,0.942,0.001,0.002],[0.002,0.0036,0.002,0.942,0.002,0.003]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>p<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>As we could see, there’s no difference in composition between the left and right palm samples. Similar result can be found using binary Jaccard metrics. Adjust the <code>dist = distance(ps.rarefied, method="jaccard", binary = TRUE)</code> and <code>permanova_pairwise &lt;- adonis(distance(ps.subs, method="jaccard", binary = TRUE) ~ body.site, data = metadata_sub)</code>, give it a try</p>
</div>
<div id="nmds-and-anosim" class="section level4">
<h4><a href="https://mb3is.megx.net/gustame/dissimilarity-based-methods/nmds">NMDS</a> and <a href="https://mb3is.megx.net/gustame/hypothesis-tests/anosim">ANOSIM</a></h4>
<p>Given that the microbiome data is compositional and sparse, non-parametric multidimentional scaling (NMDS) is favored sometimes, which usually alinged with ANOSIM test.</p>
<ul>
<li><em>Binary Jaccard</em></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>dist =<span class="st"> </span>phyloseq<span class="op">::</span><span class="kw">distance</span>(ps.rarefied, <span class="dt">method=</span><span class="st">&quot;jaccard&quot;</span>, <span class="dt">binary =</span> <span class="ot">TRUE</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>ordination =<span class="st"> </span><span class="kw">ordinate</span>(ps.rarefied, <span class="dt">method=</span><span class="st">&quot;NMDS&quot;</span>, <span class="dt">distance=</span>dist)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">plot_ordination</span>(ps.rarefied, ordination, <span class="dt">color=</span><span class="st">&quot;body.site&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.background =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" width="768" /></p>
<p><em>ANOSIM</em></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>metadata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.rarefied))</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw">anosim</span>(dist, metadata<span class="op">$</span>body.site)</span></code></pre></div>
<pre><code>## 
## Call:
## anosim(x = dist, grouping = metadata$body.site) 
## Dissimilarity: binary jaccard 
## 
## ANOSIM statistic R: 0.785 
##       Significance: 0.001 
## 
## Permutation: free
## Number of permutations: 999</code></pre>
<p><em>PAIRWISE ANOSIM</em></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>cbn &lt;-<span class="st"> </span><span class="kw">combn</span>(<span class="dt">x=</span><span class="kw">unique</span>(metadata<span class="op">$</span>body.site), <span class="dt">m =</span> <span class="dv">2</span>)</span>
<span id="cb19-2"><a href="#cb19-2"></a>p &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(cbn)){</span>
<span id="cb19-5"><a href="#cb19-5"></a>ps.subs &lt;-<span class="st"> </span><span class="kw">subset_samples</span>(ps.rarefied, body.site <span class="op">%in%</span><span class="st"> </span>cbn[,i])</span>
<span id="cb19-6"><a href="#cb19-6"></a>metadata_sub &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.subs))</span>
<span id="cb19-7"><a href="#cb19-7"></a>permanova_pairwise &lt;-<span class="st"> </span><span class="kw">anosim</span>(phyloseq<span class="op">::</span><span class="kw">distance</span>(ps.subs, <span class="dt">method=</span><span class="st">&quot;jaccard&quot;</span>, <span class="dt">binary =</span> <span class="ot">TRUE</span>), </span>
<span id="cb19-8"><a href="#cb19-8"></a>                             metadata_sub<span class="op">$</span>body.site)</span>
<span id="cb19-9"><a href="#cb19-9"></a>p &lt;-<span class="st"> </span><span class="kw">c</span>(p, permanova_pairwise<span class="op">$</span>signif[<span class="dv">1</span>])</span>
<span id="cb19-10"><a href="#cb19-10"></a>}</span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a>p.adj &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(p, <span class="dt">method =</span> <span class="st">&quot;BH&quot;</span>)</span>
<span id="cb19-13"><a href="#cb19-13"></a>p.table &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(<span class="kw">t</span>(cbn), <span class="dt">p=</span>p, <span class="dt">p.adj=</span>p.adj)</span></code></pre></div>
<div id="htmlwidget-5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5">{"x":{"filter":"none","data":[["gut","gut","gut","left palm","left palm","right palm"],["left palm","right palm","tongue","right palm","tongue","tongue"],[0.001,0.001,0.001,0.765,0.001,0.001],[0.0012,0.0012,0.0012,0.765,0.0012,0.0012]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>p<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The NMDS and ANOSIM result were similar to that from PCoA and ADONIS.</p>
</div>
</div>
<div id="abundance-bar-plot" class="section level2">
<h2>Abundance bar plot</h2>
<p>Here the demos use un-rarefied table to show all detected tags.</p>
<ul>
<li><em>Phylum</em></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>ps.rel =<span class="st"> </span><span class="kw">transform_sample_counts</span>(ps, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x)<span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co"># agglomerate taxa</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>glom &lt;-<span class="st"> </span><span class="kw">tax_glom</span>(ps.rel, <span class="dt">taxrank =</span> <span class="st">&#39;Phylum&#39;</span>, <span class="dt">NArm =</span> <span class="ot">FALSE</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a>ps.melt &lt;-<span class="st"> </span><span class="kw">psmelt</span>(glom)</span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co"># change to character for easy-adjusted level</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>ps.melt<span class="op">$</span>Phylum &lt;-<span class="st"> </span><span class="kw">as.character</span>(ps.melt<span class="op">$</span>Phylum)</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a>ps.melt &lt;-<span class="st"> </span>ps.melt <span class="op">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="st">  </span><span class="kw">group_by</span>(body.site, Phylum) <span class="op">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">median=</span><span class="kw">median</span>(Abundance))</span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co"># select group median &gt; 1</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>keep &lt;-<span class="st"> </span><span class="kw">unique</span>(ps.melt<span class="op">$</span>Phylum[ps.melt<span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>])</span>
<span id="cb20-13"><a href="#cb20-13"></a>ps.melt<span class="op">$</span>Phylum[<span class="op">!</span>(ps.melt<span class="op">$</span>Phylum <span class="op">%in%</span><span class="st"> </span>keep)] &lt;-<span class="st"> &quot;&lt; 1%&quot;</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="co">#to get the same rows together</span></span>
<span id="cb20-15"><a href="#cb20-15"></a>ps.melt_sum &lt;-<span class="st"> </span>ps.melt <span class="op">%&gt;%</span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="st">  </span><span class="kw">group_by</span>(Sample,body.site,Phylum) <span class="op">%&gt;%</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Abundance=</span><span class="kw">sum</span>(Abundance))</span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="kw">ggplot</span>(ps.melt_sum, <span class="kw">aes</span>(<span class="dt">x =</span> Sample, <span class="dt">y =</span> Abundance, <span class="dt">fill =</span> Phylum)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill=</span>Phylum)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;&quot;</span>, <span class="dt">y=</span><span class="st">&quot;%&quot;</span>) <span class="op">+</span></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>body.site, <span class="dt">scales=</span> <span class="st">&quot;free_x&quot;</span>, <span class="dt">nrow=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-24"><a href="#cb20-24"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.background =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb20-25"><a href="#cb20-25"></a>        <span class="dt">axis.text.x.bottom =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">-90</span>))</span></code></pre></div>
<p><img src="index_files/figure-html/phylum_abun-1.png" width="768" />
<code>&lt; 1%</code> indicates rare taxa in each group, with median relative abundance &lt; 1%.</p>
<ul>
<li><em>Genus</em></li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>ps.rel =<span class="st"> </span><span class="kw">transform_sample_counts</span>(ps, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x)<span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co"># agglomerate taxa</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>glom &lt;-<span class="st"> </span><span class="kw">tax_glom</span>(ps.rel, <span class="dt">taxrank =</span> <span class="st">&#39;Genus&#39;</span>, <span class="dt">NArm =</span> <span class="ot">FALSE</span>)</span>
<span id="cb21-4"><a href="#cb21-4"></a>ps.melt &lt;-<span class="st"> </span><span class="kw">psmelt</span>(glom)</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co"># change to character for easy-adjusted level</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>ps.melt<span class="op">$</span>Genus &lt;-<span class="st"> </span><span class="kw">as.character</span>(ps.melt<span class="op">$</span>Genus)</span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a>ps.melt &lt;-<span class="st"> </span>ps.melt <span class="op">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="st">  </span><span class="kw">group_by</span>(body.site, Genus) <span class="op">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">median=</span><span class="kw">median</span>(Abundance))</span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co"># select group mean &gt; 1</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>keep &lt;-<span class="st"> </span><span class="kw">unique</span>(ps.melt<span class="op">$</span>Genus[ps.melt<span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="fl">2.5</span>])</span>
<span id="cb21-13"><a href="#cb21-13"></a>ps.melt<span class="op">$</span>Genus[<span class="op">!</span>(ps.melt<span class="op">$</span>Genus <span class="op">%in%</span><span class="st"> </span>keep)] &lt;-<span class="st"> &quot;&lt; 2.5%&quot;</span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="co">#to get the same rows together</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>ps.melt_sum &lt;-<span class="st"> </span>ps.melt <span class="op">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="st">  </span><span class="kw">group_by</span>(Sample,body.site,Genus) <span class="op">%&gt;%</span></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Abundance=</span><span class="kw">sum</span>(Abundance))</span>
<span id="cb21-18"><a href="#cb21-18"></a></span>
<span id="cb21-19"><a href="#cb21-19"></a><span class="kw">ggplot</span>(ps.melt_sum, <span class="kw">aes</span>(<span class="dt">x =</span> Sample, <span class="dt">y =</span> Abundance, <span class="dt">fill =</span> Genus)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill=</span>Genus)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb21-21"><a href="#cb21-21"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;&quot;</span>, <span class="dt">y=</span><span class="st">&quot;%&quot;</span>) <span class="op">+</span></span>
<span id="cb21-22"><a href="#cb21-22"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>body.site, <span class="dt">scales=</span> <span class="st">&quot;free_x&quot;</span>, <span class="dt">nrow=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb21-23"><a href="#cb21-23"></a><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb21-24"><a href="#cb21-24"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>, </span>
<span id="cb21-25"><a href="#cb21-25"></a>        <span class="dt">strip.background =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb21-26"><a href="#cb21-26"></a>        <span class="dt">axis.text.x.bottom =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">-90</span>))</span></code></pre></div>
<p><img src="index_files/figure-html/genus_abun-1.png" width="768" />
<code>&lt; 2.5%</code> indicates rare taxa in each group, with median relative abundance &lt; 2.5%.</p>
</div>
<div id="differential-abundance-analysis" class="section level2">
<h2>Differential abundance analysis</h2>
<p>Differential abundance analysis allows you to identify differentially abundant taxa between groups. There’s many methods, here two commonly used ones are given as examples. Features are collapsed at the species-level prior to the calculation.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">sample_data</span>(ps)<span class="op">$</span>body.site &lt;-<span class="st"> </span><span class="kw">as.factor</span>(<span class="kw">sample_data</span>(ps)<span class="op">$</span>body.site) <span class="co"># factorize for DESeq2</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>ps.taxa &lt;-<span class="st"> </span><span class="kw">tax_glom</span>(ps, <span class="dt">taxrank =</span> <span class="st">&#39;Species&#39;</span>, <span class="dt">NArm =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p>Let’s see what features are enriched differentially between tongue and gut.</p>
<div id="deseq2" class="section level3">
<h3>DESeq2</h3>
<p>DESeq2 is a software designed for RNA-seq, but also used in <a href="https://joey711.github.io/phyloseq-extensions/DESeq2.html">microbiome analysis</a>, and the detailed use of DESeq2 can be found <a href="http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#variations-to-the-standard-workflow">here</a>. However, you’re usually troubled by the “zero” issues in microbiome analysis. A pseudo count is added to avoid the issues of logarithm transformation.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>ps.taxa.pse &lt;-<span class="st"> </span>ps.taxa</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw">otu_table</span>(ps.taxa.pse) &lt;-<span class="st"> </span><span class="kw">otu_table</span>(ps.taxa) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># pairwise comparison between gut and tongue</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>ps.taxa.pse.sub &lt;-<span class="st"> </span><span class="kw">subset_samples</span>(ps.taxa.pse, body.site <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;gut&quot;</span>, <span class="st">&quot;tongue&quot;</span>))</span>
<span id="cb23-5"><a href="#cb23-5"></a>ds =<span class="st"> </span><span class="kw">phyloseq_to_deseq2</span>(ps.taxa.pse.sub, <span class="op">~</span><span class="st"> </span>body.site)</span>
<span id="cb23-6"><a href="#cb23-6"></a>ds =<span class="st"> </span><span class="kw">DESeq</span>(ds, <span class="dt">test=</span><span class="st">&quot;Wald&quot;</span>, <span class="dt">fitType=</span><span class="st">&quot;parametric&quot;</span>)</span>
<span id="cb23-7"><a href="#cb23-7"></a>alpha =<span class="st"> </span><span class="fl">0.05</span> </span>
<span id="cb23-8"><a href="#cb23-8"></a>res =<span class="st"> </span><span class="kw">results</span>(ds, <span class="dt">alpha=</span>alpha)</span>
<span id="cb23-9"><a href="#cb23-9"></a>res =<span class="st"> </span>res[<span class="kw">order</span>(res<span class="op">$</span>padj, <span class="dt">na.last=</span><span class="ot">NA</span>), ]</span>
<span id="cb23-10"><a href="#cb23-10"></a>taxa_sig =<span class="st"> </span><span class="kw">rownames</span>(res[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, ]) <span class="co"># select bottom 20 with lowest p.adj values</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>ps.taxa.rel &lt;-<span class="st"> </span><span class="kw">transform_sample_counts</span>(ps, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x)<span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb23-12"><a href="#cb23-12"></a>ps.taxa.rel.sig &lt;-<span class="st"> </span><span class="kw">prune_taxa</span>(taxa_sig, ps.taxa.rel)</span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="co"># Only keep gut and tongue samples</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>ps.taxa.rel.sig &lt;-<span class="st"> </span><span class="kw">prune_samples</span>(<span class="kw">colnames</span>(<span class="kw">otu_table</span>(ps.taxa.pse.sub)), ps.taxa.rel.sig)</span></code></pre></div>
<p>Visualize these biomarkers in heatmap using R package <a href="https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html">ComplexHeatmap</a>, which is an improved package on the basis of pheatmap. A detailed reference book about ComplexHeatmap is <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/">here</a>. I like it because of its flexibility relative to built-in heatmap(), gplots::heatmap.2(), pheatmap::pheatmap() and heatmap3::heatmap(). However, the mentioned ones can also be adopted given the same theory of heatmap. The added function <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/integrate-with-other-packages.html#pheatmap">ComplexHeatmap::pheatmap</a> inherited most settings of pheatmap, so I adopt it to make code easily understood.</p>
<p>To make <code>pheatmap</code> specfic, it is written as <code>ComplexHeatmap::pheatmap</code></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>matrix &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">data.frame</span>(<span class="kw">otu_table</span>(ps.taxa.rel.sig)))</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="kw">rownames</span>(matrix) &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">tax_table</span>(ps.taxa.rel.sig)[, <span class="st">&quot;Species&quot;</span>])</span>
<span id="cb24-3"><a href="#cb24-3"></a>metadata_sub &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.taxa.rel.sig))</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co"># Define the annotation color for columns and rows</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>annotation_col =<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb24-6"><a href="#cb24-6"></a>    <span class="dt">Subject =</span> <span class="kw">as.factor</span>(metadata_sub<span class="op">$</span>subject), </span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="st">`</span><span class="dt">Body site</span><span class="st">`</span> =<span class="st"> </span><span class="kw">as.factor</span>(metadata_sub<span class="op">$</span>body.site), </span>
<span id="cb24-8"><a href="#cb24-8"></a>    <span class="dt">check.names =</span> <span class="ot">FALSE</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>)</span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="kw">rownames</span>(annotation_col) =<span class="st"> </span><span class="kw">rownames</span>(metadata_sub)</span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a>annotation_row =<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="dt">Phylum =</span> <span class="kw">as.factor</span>(<span class="kw">tax_table</span>(ps.taxa.rel.sig)[, <span class="st">&quot;Phylum&quot;</span>])</span>
<span id="cb24-14"><a href="#cb24-14"></a>)</span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="kw">rownames</span>(annotation_row) =<span class="st"> </span><span class="kw">rownames</span>(matrix)</span>
<span id="cb24-16"><a href="#cb24-16"></a></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="co"># ann_color should be named vectors</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>phylum_col =<span class="st"> </span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="kw">length</span>(<span class="kw">levels</span>(annotation_row<span class="op">$</span>Phylum)), <span class="st">&quot;Paired&quot;</span>)</span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="kw">names</span>(phylum_col) =<span class="st"> </span><span class="kw">levels</span>(annotation_row<span class="op">$</span>Phylum)</span>
<span id="cb24-20"><a href="#cb24-20"></a>ann_colors =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb24-21"><a href="#cb24-21"></a>    <span class="dt">Subject =</span> <span class="kw">c</span>(<span class="st">`</span><span class="dt">subject-1</span><span class="st">`</span> =<span class="st"> &quot;red&quot;</span>, <span class="st">`</span><span class="dt">subject-2</span><span class="st">`</span> =<span class="st"> &quot;blue&quot;</span>),</span>
<span id="cb24-22"><a href="#cb24-22"></a>    <span class="st">`</span><span class="dt">Body site</span><span class="st">`</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gut =</span> <span class="st">&quot;purple&quot;</span>, <span class="dt">tongue =</span> <span class="st">&quot;yellow&quot;</span>),</span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="dt">Phylum =</span> phylum_col</span>
<span id="cb24-24"><a href="#cb24-24"></a>)</span>
<span id="cb24-25"><a href="#cb24-25"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a>ComplexHeatmap<span class="op">::</span><span class="kw">pheatmap</span>(matrix, <span class="dt">scale=</span> <span class="st">&quot;row&quot;</span>, </span>
<span id="cb24-27"><a href="#cb24-27"></a>                         <span class="dt">annotation_col =</span> annotation_col, </span>
<span id="cb24-28"><a href="#cb24-28"></a>                         <span class="dt">annotation_row =</span> annotation_row, </span>
<span id="cb24-29"><a href="#cb24-29"></a>                         <span class="dt">annotation_colors =</span> ann_colors)</span></code></pre></div>
<p><img src="index_files/figure-html/deseq2-1.png" width="768" /></p>
</div>
<div id="ancom-bc" class="section level3">
<h3>ANCOM-BC</h3>
<p>Here I will introduce another statistical method specially designed for Microbiome data. I like its theory behind - sequencing is a process of sampling. For a microbial community under adequate sequencing, the ratio of two specific taxa should be theoretically the “same” between their profiled relative abundances and the absolute abundance. The theory can be found in their <a href="https://www.nature.com/articles/s41467-020-17041-7">published paper</a>. ANCOM is one recommended method by QIIME 2 and similar theory is also adopted in another QIIME 2 plugin- <a href="https://docs.qiime2.org/2020.11/tutorials/gneiss/">Geneiss</a>. ANCOM is originally written in R and hosted in NIH, but the link has expired now. The <a href="https://docs.qiime2.org/2020.11/plugins/available/composition/">q2-compositon</a> plugin is one accessible version to my knowledge. In that QIIME has no R API, I recommend to use improved ANCOM version e.g. <a href="https://github.com/FrederickHuangLin/ANCOM">ANCOM 2</a> and <a href="https://github.com/FrederickHuangLin/ANCOMBC">ANCOM-BC</a> if you only eat R code. These two have not been included in QIIME 2 and maintained by the lab members of the original ANCOM paper. The key differences between ANCOM 2 and ANCOM are how they treat <em>zeros</em> and introduced process of repeated data, and more can be found in the <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5682008/">paper</a>. Considering the structure of code, ANCOM 2 is more like a wrapped R function of ANCOM, especially relative to ANCOM-BC. ANCOM-BC inherited the methodology of preprocessing <em>zeros</em> in ANCOM but estimated the sampling bias by linear regression. Besides, it provides <em>p</em> values and according to the author, it is blazingly fast while controlling the FDR and maintaining adequate power. ANCOM-BC is maintained at <a href="http://www.bioconductor.org/packages/release/bioc/html/ANCOMBC.html">bioconductor</a>, and a vignette is <a href="http://www.bioconductor.org/packages/release/bioc/vignettes/ANCOMBC/inst/doc/ANCOMBC.html">here</a>. It’s worth noting that ANCOM-BC is in development and now (Jan 2021) <a href="https://github.com/FrederickHuangLin/ANCOMBC/issues/5">only support testing for co-variates and global test</a>.</p>
<p>So we adopt ANCOM-BC to repeat the test above. And here it takes <em>gut</em> label as a reference to other <em>body site</em> groups.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># pairwise comparison between gut and tongue</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>ps.taxa.sub &lt;-<span class="st"> </span><span class="kw">subset_samples</span>(ps.taxa, body.site <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;gut&quot;</span>, <span class="st">&quot;tongue&quot;</span>))</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co"># ancombc</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>out &lt;-<span class="st"> </span><span class="kw">ancombc</span>(<span class="dt">phyloseq =</span> ps.taxa.sub, <span class="dt">formula =</span> <span class="st">&quot;body.site&quot;</span>, </span>
<span id="cb25-5"><a href="#cb25-5"></a>              <span class="dt">p_adj_method =</span> <span class="st">&quot;holm&quot;</span>, <span class="dt">zero_cut =</span> <span class="fl">0.90</span>, <span class="dt">lib_cut =</span> <span class="dv">1000</span>, </span>
<span id="cb25-6"><a href="#cb25-6"></a>              <span class="dt">group =</span> <span class="st">&quot;body.site&quot;</span>, <span class="dt">struc_zero =</span> <span class="ot">TRUE</span>, <span class="dt">neg_lb =</span> <span class="ot">TRUE</span>, <span class="dt">tol =</span> <span class="fl">1e-5</span>, </span>
<span id="cb25-7"><a href="#cb25-7"></a>              <span class="dt">max_iter =</span> <span class="dv">100</span>, <span class="dt">conserve =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">global =</span> <span class="ot">TRUE</span>)</span>
<span id="cb25-8"><a href="#cb25-8"></a>res &lt;-<span class="st"> </span>out<span class="op">$</span>res</span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co"># select the bottom 20 with lowest p values</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>res.or_p &lt;-<span class="st"> </span><span class="kw">rownames</span>(res<span class="op">$</span>q_val[,<span class="st">&quot;body.sitetongue&quot;</span>])[base<span class="op">::</span><span class="kw">order</span>(res<span class="op">$</span>q_val[,<span class="st">&quot;body.sitetongue&quot;</span>])]</span>
<span id="cb25-11"><a href="#cb25-11"></a>taxa_sig &lt;-<span class="st"> </span>res.or_p[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb25-12"><a href="#cb25-12"></a>ps.taxa.rel.sig &lt;-<span class="st"> </span><span class="kw">prune_taxa</span>(taxa_sig, ps.taxa.rel)</span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="co"># Only keep gut and tongue samples </span></span>
<span id="cb25-14"><a href="#cb25-14"></a>ps.taxa.rel.sig &lt;-<span class="st"> </span><span class="kw">prune_samples</span>(<span class="kw">colnames</span>(<span class="kw">otu_table</span>(ps.taxa.sub)), ps.taxa.rel.sig)</span></code></pre></div>
<p>Repeat heatmap script for the ANCOM result</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>matrix &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">data.frame</span>(<span class="kw">otu_table</span>(ps.taxa.rel.sig)))</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="kw">rownames</span>(matrix) &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">tax_table</span>(ps.taxa.rel.sig)[, <span class="st">&quot;Species&quot;</span>])</span>
<span id="cb26-3"><a href="#cb26-3"></a>metadata_sub &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">sample_data</span>(ps.taxa.rel.sig))</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co"># Define the annotation color for columns and rows</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>annotation_col =<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="dt">Subject =</span> <span class="kw">as.factor</span>(metadata_sub<span class="op">$</span>subject), </span>
<span id="cb26-7"><a href="#cb26-7"></a>    <span class="st">`</span><span class="dt">Body site</span><span class="st">`</span> =<span class="st"> </span><span class="kw">as.factor</span>(metadata_sub<span class="op">$</span>body.site), </span>
<span id="cb26-8"><a href="#cb26-8"></a>    <span class="dt">check.names =</span> <span class="ot">FALSE</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>)</span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="kw">rownames</span>(annotation_col) =<span class="st"> </span><span class="kw">rownames</span>(metadata_sub)</span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a>annotation_row =<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb26-13"><a href="#cb26-13"></a>    <span class="dt">Phylum =</span> <span class="kw">as.factor</span>(<span class="kw">tax_table</span>(ps.taxa.rel.sig)[, <span class="st">&quot;Phylum&quot;</span>])</span>
<span id="cb26-14"><a href="#cb26-14"></a>)</span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="kw">rownames</span>(annotation_row) =<span class="st"> </span><span class="kw">rownames</span>(matrix)</span>
<span id="cb26-16"><a href="#cb26-16"></a></span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="co"># ann_color should be named vectors</span></span>
<span id="cb26-18"><a href="#cb26-18"></a>phylum_col =<span class="st"> </span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="kw">length</span>(<span class="kw">levels</span>(annotation_row<span class="op">$</span>Phylum)), <span class="st">&quot;Paired&quot;</span>)</span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="kw">names</span>(phylum_col) =<span class="st"> </span><span class="kw">levels</span>(annotation_row<span class="op">$</span>Phylum)</span>
<span id="cb26-20"><a href="#cb26-20"></a>ann_colors =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb26-21"><a href="#cb26-21"></a>    <span class="dt">Subject =</span> <span class="kw">c</span>(<span class="st">`</span><span class="dt">subject-1</span><span class="st">`</span> =<span class="st"> &quot;red&quot;</span>, <span class="st">`</span><span class="dt">subject-2</span><span class="st">`</span> =<span class="st"> &quot;blue&quot;</span>),</span>
<span id="cb26-22"><a href="#cb26-22"></a>    <span class="st">`</span><span class="dt">Body site</span><span class="st">`</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">gut</span><span class="st">`</span> =<span class="st"> &quot;purple&quot;</span>, <span class="dt">tongue =</span> <span class="st">&quot;yellow&quot;</span>),</span>
<span id="cb26-23"><a href="#cb26-23"></a>    <span class="dt">Phylum =</span> phylum_col</span>
<span id="cb26-24"><a href="#cb26-24"></a>)</span>
<span id="cb26-25"><a href="#cb26-25"></a>ComplexHeatmap<span class="op">::</span><span class="kw">pheatmap</span>(matrix, <span class="dt">scale=</span> <span class="st">&quot;row&quot;</span>, </span>
<span id="cb26-26"><a href="#cb26-26"></a>                         <span class="dt">annotation_col =</span> annotation_col, </span>
<span id="cb26-27"><a href="#cb26-27"></a>                         <span class="dt">annotation_row =</span> annotation_row, </span>
<span id="cb26-28"><a href="#cb26-28"></a>                         <span class="dt">annotation_colors =</span> ann_colors)</span></code></pre></div>
<p><img src="index_files/figure-html/ancombc-1.png" width="768" /></p>
<p>The <em>mini</em>-tour shall end here. In that you know how to import the microbiome data in R, you can continue exploring your data according to diverse tutorials including <a href="https://joey711.github.io/phyloseq/">phyloseq</a> from U.S., <a href="https://madsalbertsen.github.io/ampvis2/articles/ampvis2.html">ampvis2</a> from Denmark, and <a href="https://yulab-smu.top/MicrobiotaProcessWorkshop/articles/MicrobiotaProcessWorkshop.html">MicrobiotaProcess</a> from China.</p>
<p>If you want a GUI software for your microbiome analysis, you may like <a href="https://www.microbiomeanalyst.ca/">microbiomeanalyst</a>, which was recently published on <a href="https://www.nature.com/articles/s41596-019-0264-1">Nature protocol</a>. I haven’t tried it yet in that I hate mouse clicking.😱</p>
</div>
</div>
