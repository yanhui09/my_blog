---
title: Simple tutorial for microbiome analysis in R
author: Yan Hui
date: '2021-01-01'
slug: []
categories: []
tags:
  - Microbiome
  - R
draft: FALSE
---

<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>


<p><strong>BEFORE YOU START:</strong> This is a <em>minimal tutorial</em> to visualize microbiome result with R. The tutorial starts from the processed output from metagenomic sequencing, e.g.¬†feature matrix. It‚Äôs suitable for someone who wants to try a hand-on analysis, especially for <strong>R users</strong>, helping you understand the basic concepts of microbiome outputs. This tutorial will only give inspirations for some common analysis (alpha/beta diversity, differential abundance analysis)Ôºå but it shall be adequate if you only consider microbiome as a sub-story.</p>
<ul>
<li>The demo data-set comes from the <a href="https://qiime2.org/">QIIME 2</a> tutorial - <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving Pictures</a>.</li>
<li>This is a <strong>beginner tutorial</strong>. You still have time to run away if you‚Äôre an experienced bioinformatician. üëª</li>
</ul>
<div id="what-will-you-work-on" class="section level2">
<h2>WHAT WILL YOU WORK ON</h2>
<p>After sequencing, you will get some (<a href="https://en.wikipedia.org/wiki/FASTQ_format">fastq</a>/<a href="https://nanoporetech.com/nanopore-sequencing-data-analysis">fast5</a>/<a href="http://files.pacb.com/software/instrument/2.0.0/bas.h5%20Reference%20Guide.pdf">h5</a>) files from the sequencing. These files contain the base information e.g.¬†quality of collected reads. If the sequenced sample is a mixed community, i.e.¬†metagenomic sequencing, . There are plenty of strategies e.g.¬†Amplicon/Shotgun sequencing to utilize these reads.</p>
<ul>
<li>Feature table (Necessary), a matrix containing the abundances of detected microbial features(OTUs, ASVs, microbial markers)</li>
<li>Taxonomy table (Optional), an array indicating the taxonomy of the features, which can be integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>.</li>
<li>Phylogenetic tree (Optional), a phylogenetic tree indicating the similarity of microbial features, potentially used when calculating phylogentic diversity metrics (optionally integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>).</li>
<li>Metadata, a matrix containing the infomation for analysis (optionally integrated in <a href="https://biom-format.org/documentation/format_versions/biom-2.1.html">biom format</a>).</li>
</ul>
</div>
<div id="preparation" class="section level2">
<h2>Preparation</h2>
<p><strong>If you are using QIIME 2 pipeline</strong>, <a href="https://docs.qiime2.org/2020.11/concepts/">qza</a>(<em>zipped format named by QIIME 2</em>) files are what you needed. Below are the data from <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">Moving Pictures</a>.</p>
<pre><code>## rooted-tree.qza
## sample-metadata.tsv
## table.qza
## taxonomy.qza</code></pre>
<p>As the R buildins didn‚Äôt accept .qza or .biom files, here I give a example to transform these qza files to a R-like format. You need QIIME 2 (qiime2-2020.11) installed.</p>
<pre class="bash"><code>conda activate qiime2-2020.11
for i in *.qza; do
qiime tools export --input-path $i --output-path .
done
biom convert -i feature-table.biom -o feature-table.tsv --to-tsv
conda deactivate</code></pre>
<p>And you will have</p>
<pre><code>## feature-table.tsv
## sample-metadata.tsv
## taxonomy.tsv
## tree.nwk</code></pre>
<p>Install and load relevant packages: <a href="https://github.com/joey711/phyloseq">phyloseq</a>, <a href="https://ggplot2.tidyverse.org/">tidyverse</a>, <a href="https://cran.r-project.org/web/packages/vegan/index.html">vegan</a>, <a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html">DESeq2</a> , <a href="http://www.bioconductor.org/packages/release/bioc/html/ANCOMBC.html">ANCOMBC</a>, <a href="https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html">ComplexHeatmap</a>. You can copy the code below.</p>
<pre class="r"><code>p1 &lt;- c(&quot;tidyverse&quot;, &quot;vegan&quot;, &quot;BiocManager&quot;)
p2 &lt;- c(&quot;phyloseq&quot;, &quot;ANCOMBC&quot;, &quot;DESeq2&quot;, &quot;ComplexHeatmap&quot;)
load_package &lt;- function(p) {
  if (!requireNamespace(p, quietly = TRUE)) {
    ifelse(p %in% p1, install.packages(p, repos = &quot;http://cran.us.r-project.org/&quot;), BiocManager::install(p))
  }
  library(p, character.only = TRUE, quietly = TRUE)
}
invisible(lapply(c(p1,p2), load_package))</code></pre>
</div>
<div id="build-phyloseq-project" class="section level2">
<h2>Build phyloseq project</h2>
<p>Load data to build a phyloseq project, phyloseq description is <a href="https://joey711.github.io/phyloseq/import-data.html">here</a>.</p>
<pre class="r"><code>otu &lt;- read.table(file = &quot;feature-table.tsv&quot;, sep = &quot;\t&quot;, header = T, row.names = 1, skip = 1, comment.char = &quot;&quot;)
taxonomy &lt;- read.table(file = &quot;taxonomy.tsv&quot;, sep = &quot;\t&quot;, header = T ,row.names = 1)

# clean the taxonomy, Greengenes format
tax &lt;- taxonomy %&gt;%
  select(Taxon) %&gt;% 
  separate(Taxon, c(&quot;Kingdom&quot;, &quot;Phylum&quot;, &quot;Class&quot;, &quot;Order&quot;, &quot;Family&quot;, &quot;Genus&quot;, &quot;Species&quot;), &quot;; &quot;)

tax.clean &lt;- data.frame(row.names = row.names(tax),
                        Kingdom = str_replace(tax[,1], &quot;k__&quot;,&quot;&quot;),
                        Phylum = str_replace(tax[,2], &quot;p__&quot;,&quot;&quot;),
                        Class = str_replace(tax[,3], &quot;c__&quot;,&quot;&quot;),
                        Order = str_replace(tax[,4], &quot;o__&quot;,&quot;&quot;),
                        Family = str_replace(tax[,5], &quot;f__&quot;,&quot;&quot;),
                        Genus = str_replace(tax[,6], &quot;g__&quot;,&quot;&quot;),
                        Species = str_replace(tax[,7], &quot;s__&quot;,&quot;&quot;),
                        stringsAsFactors = FALSE)

tax.clean[is.na(tax.clean)] &lt;- &quot;&quot;
tax.clean[tax.clean==&quot;__&quot;] &lt;- &quot;&quot;

for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,7] != &quot;&quot;){
    tax.clean$Species[i] &lt;- paste(tax.clean$Genus[i], tax.clean$Species[i], sep = &quot; &quot;)
  } else if (tax.clean[i,2] == &quot;&quot;){
    kingdom &lt;- paste(&quot;Unclassified&quot;, tax.clean[i,1], sep = &quot; &quot;)
    tax.clean[i, 2:7] &lt;- kingdom
  } else if (tax.clean[i,3] == &quot;&quot;){
    phylum &lt;- paste(&quot;Unclassified&quot;, tax.clean[i,2], sep = &quot; &quot;)
    tax.clean[i, 3:7] &lt;- phylum
  } else if (tax.clean[i,4] == &quot;&quot;){
    class &lt;- paste(&quot;Unclassified&quot;, tax.clean[i,3], sep = &quot; &quot;)
    tax.clean[i, 4:7] &lt;- class
  } else if (tax.clean[i,5] == &quot;&quot;){
    order &lt;- paste(&quot;Unclassified&quot;, tax.clean[i,4], sep = &quot; &quot;)
    tax.clean[i, 5:7] &lt;- order
  } else if (tax.clean[i,6] == &quot;&quot;){
    family &lt;- paste(&quot;Unclassified&quot;, tax.clean[i,5], sep = &quot; &quot;)
    tax.clean[i, 6:7] &lt;- family
  } else if (tax.clean[i,7] == &quot;&quot;){
    tax.clean$Species[i] &lt;- paste(&quot;Unclassified &quot;,tax.clean$Genus[i], sep = &quot; &quot;)
  }
}

metadata &lt;- read.table(file = &quot;sample-metadata.tsv&quot;, sep = &quot;\t&quot;, header = T, row.names = 1)
OTU = otu_table(as.matrix(otu), taxa_are_rows = TRUE)
TAX = tax_table(as.matrix(tax.clean))
SAMPLE &lt;- sample_data(metadata)
TREE = read_tree(&quot;tree.nwk&quot;)
# merge the data
ps &lt;- phyloseq(OTU, TAX, SAMPLE,TREE)</code></pre>
<p>The phyloseq project looks like</p>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 770 taxa and 34 samples ]
## sample_data() Sample Data:       [ 34 samples by 8 sample variables ]
## tax_table()   Taxonomy Table:    [ 770 taxa by 7 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 770 tips and 768 internal nodes ]</code></pre>
</div>
<div id="check-the-sequencing-depth-with-rarefaction-curve" class="section level2">
<h2>Check the sequencing depth with rarefaction curve</h2>
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>The sequencing depth is 4523.735 ¬± 2933.477 (mean ¬± SD), ranging from 897 to 9820.</p>
<p>As we could see, a sequencing depth of 1000 has captured most taxonomic tags. To minimize the bias from varying sequenicng depth, it‚Äôs recommended to do a rarefaction before calculating diversity metrics. However, it‚Äôs <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003531">not always the rule of thumb</a>. To keep consistence with the <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">QIIME 2 tutorial</a>, we rarefy (resample) all samples to the sequencing depth of 1103. (As it‚Äôs random sampling process, the result is unlikely to be identical as the <a href="https://docs.qiime2.org/2020.11/tutorials/moving-pictures/">QIIME 2 tutorial</a>)</p>
<pre class="r"><code>set.seed(111) # keep result reproductive
ps.rarefied = rarefy_even_depth(ps, rngseed=1, sample.size=1103, replace=F)</code></pre>
<p>After rarefaction, the phyloseq looks like</p>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 666 taxa and 31 samples ]
## sample_data() Sample Data:       [ 31 samples by 8 sample variables ]
## tax_table()   Taxonomy Table:    [ 666 taxa by 7 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 666 tips and 664 internal nodes ]</code></pre>
<p>The sequencing depth of all remaining 31 samples is 1103.</p>
</div>
<div id="alpha-diversity" class="section level2">
<h2>Alpha diversity</h2>
<p>Alpha diversity metrics assess the species diversity within the ecosystems, telling you how diverse a sequenced community is.</p>
<pre class="r"><code>plot_richness(ps.rarefied, x=&quot;body.site&quot;, measures=c(&quot;Observed&quot;, &quot;Shannon&quot;)) +
  geom_boxplot() +
  theme_classic() +
  theme(strip.background = element_blank(), axis.text.x.bottom = element_text(angle = -90))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>We could see tongue samples had the lowest alpha diversity. Next, some statistics: pairwise test with Wilcoxon rank-sum test, with fdr correction. For the number of observed tags,</p>
<pre class="r"><code>rich = estimate_richness(ps.rarefied, measures = c(&quot;Observed&quot;, &quot;Shannon&quot;))
wilcox.observed &lt;- pairwise.wilcox.test(rich$Observed, sample_data(ps.rarefied)$body.site, p.adjust.method = &quot;BH&quot;)
tab.observed &lt;- wilcox.observed$p.value %&gt;%
  as.data.frame() %&gt;%
  tibble::rownames_to_column(var = &quot;group1&quot;) %&gt;%
  gather(key=&quot;group2&quot;, value=&quot;p.adj&quot;, -group1) %&gt;%
  na.omit()
tab.observed</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["left palm","right palm","tongue","right palm","tongue","tongue"],["gut","gut","gut","left palm","left palm","right palm"],[0.309861519622914,1,0.0026441634012951,1,0.0026441634012951,0.0157960566577091]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>group1<\/th>\n      <th>group2<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Similarly for Shannon diversity,</p>
<pre class="r"><code>wilcox.shannon &lt;- pairwise.wilcox.test(rich$Shannon, sample_data(ps.rarefied)$body.site, p.adjust.method = &quot;BH&quot;)
tab.shannon &lt;- wilcox.shannon$p.value %&gt;%
  as.data.frame() %&gt;%
  tibble::rownames_to_column(var = &quot;group1&quot;) %&gt;%
  gather(key=&quot;group2&quot;, value=&quot;p.adj&quot;, -group1) %&gt;%
  na.omit()
tab.shannon</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["left palm","right palm","tongue","right palm","tongue","tongue"],["gut","gut","gut","left palm","left palm","right palm"],[0.0748251748251748,0.17022977022977,0.0719045660222131,0.851814851814852,0.000987248046071575,0.00839160839160839]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>group1<\/th>\n      <th>group2<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="beta-diversity" class="section level2">
<h2>Beta diversity</h2>
<p>Beta diversity assess the dissimilarity between ecosystem, telling you to what extend one community is different from another. Here are some demo code using Bray Curtis and binary Jaccard distance. I personally do not recommend direct use of the UniFrac metrics supported by phyloseq, especially when your tree is not dichotomous. This will happen when some children branches lose their parents during rarefaction üò≠. You need to re-root your tree in e.g.¬†QIIME 2 if you run into this case, see <a href="https://github.com/joey711/phyloseq/issues/936">here</a>. Besides, the UniFrac calculation by phyloseq has not been checked with the source code, see the posts in <a href="https://github.com/joey711/phyloseq/issues/956">phyloseq issues</a> and <a href="https://forum.qiime2.org/t/very-different-weighted-unifrac-results-for-qiime2-versus-phyloseq/4591">QIIME 2 forum</a>. So it‚Äôs safer to use QIIME 2 version for now given that both QIIME and UniFrac concept came from the <a href="https://knightlab.ucsd.edu/">Knight lab</a>.</p>
<div id="pcoa-and-permanovaadonis" class="section level4">
<h4><a href="https://mb3is.megx.net/gustame/dissimilarity-based-methods/principal-coordinates-analysis">PCoA</a> and <a href="https://mb3is.megx.net/gustame/hypothesis-tests/manova/npmanova">PERMANOVA/ADONIS</a></h4>
<ul>
<li>Bray curtis</li>
</ul>
<p><code>distance</code> is in overlapped use, so we specify the package by <code>phyloseq::distance</code></p>
<pre class="r"><code>dist = phyloseq::distance(ps.rarefied, method=&quot;bray&quot;)
ordination = ordinate(ps.rarefied, method=&quot;PCoA&quot;, distance=dist)
plot_ordination(ps.rarefied, ordination, color=&quot;body.site&quot;) + 
  theme_classic() +
  theme(strip.background = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>PERMANOVA/ADONIS</p>
<pre class="r"><code>metadata &lt;- data.frame(sample_data(ps.rarefied))
test.adonis &lt;- adonis(dist ~ body.site, data = metadata)
test.adonis &lt;- as.data.frame(test.adonis$aov.tab)
test.adonis</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["body.site","Residuals","Total"],[3,27,30],[5.21390787395429,5.88330179759205,11.0972096715463],[1.7379692913181,0.217900066577483,null],[7.97599247497289,null,null],[0.469839538791715,0.530160461208285,1],[0.001,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Df<\/th>\n      <th>SumsOfSqs<\/th>\n      <th>MeanSqs<\/th>\n      <th>F.Model<\/th>\n      <th>R2<\/th>\n      <th>Pr(&gt;F)<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>PAIRWISE PERMANOVA</p>
<pre class="r"><code>cbn &lt;- combn(x=unique(metadata$body.site), m = 2)
p &lt;- c()

for(i in 1:ncol(cbn)){
ps.subs &lt;- subset_samples(ps.rarefied, body.site %in% cbn[,i])
metadata_sub &lt;- data.frame(sample_data(ps.subs))
permanova_pairwise &lt;- adonis(phyloseq::distance(ps.subs, method = &quot;bray&quot;) ~ body.site, data = metadata_sub)
p &lt;- c(p, permanova_pairwise$aov.tab$`Pr(&gt;F)`[1])
}

p.adj &lt;- p.adjust(p, method = &quot;BH&quot;)
p.table &lt;- cbind.data.frame(t(cbn), p=p, p.adj=p.adj)
p.table</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["gut","gut","gut","left palm","left palm","right palm"],["left palm","right palm","tongue","right palm","tongue","tongue"],[0.001,0.003,0.001,0.942,0.001,0.002],[0.002,0.0036,0.002,0.942,0.002,0.003]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>p<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>As we could see, there‚Äôs no difference in composition between the left and right palm samples. Similar result can be found using binary Jaccard metrics. Adjust the <code>dist = distance(ps.rarefied, method="jaccard", binary = TRUE)</code> and <code>permanova_pairwise &lt;- adonis(distance(ps.subs, method="jaccard", binary = TRUE) ~ body.site, data = metadata_sub)</code>, give it a try</p>
</div>
<div id="nmds-and-anosim" class="section level4">
<h4><a href="https://mb3is.megx.net/gustame/dissimilarity-based-methods/nmds">NMDS</a> and <a href="https://mb3is.megx.net/gustame/hypothesis-tests/anosim">ANOSIM</a></h4>
<p>Given that the microbiome data is compositional and sparse, non-parametric multidimentional scaling (NMDS) is favored sometimes, which usually alinged with ANOSIM test.</p>
<ul>
<li>Binary Jaccard</li>
</ul>
<pre class="r"><code>dist = phyloseq::distance(ps.rarefied, method=&quot;jaccard&quot;, binary = TRUE)
ordination = ordinate(ps.rarefied, method=&quot;NMDS&quot;, distance=dist)</code></pre>
<pre class="r"><code>plot_ordination(ps.rarefied, ordination, color=&quot;body.site&quot;) + 
  theme_classic() +
  theme(strip.background = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>ANOSIM</p>
<pre class="r"><code>metadata &lt;- data.frame(sample_data(ps.rarefied))
anosim(dist, metadata$body.site)</code></pre>
<pre><code>## 
## Call:
## anosim(x = dist, grouping = metadata$body.site) 
## Dissimilarity: binary jaccard 
## 
## ANOSIM statistic R: 0.785 
##       Significance: 0.001 
## 
## Permutation: free
## Number of permutations: 999</code></pre>
<p>PAIRWISE ANOSIM</p>
<pre class="r"><code>cbn &lt;- combn(x=unique(metadata$body.site), m = 2)
p &lt;- c()

for(i in 1:ncol(cbn)){
ps.subs &lt;- subset_samples(ps.rarefied, body.site %in% cbn[,i])
metadata_sub &lt;- data.frame(sample_data(ps.subs))
permanova_pairwise &lt;- anosim(phyloseq::distance(ps.subs, method=&quot;jaccard&quot;, binary = TRUE), metadata_sub$body.site)
p &lt;- c(p, permanova_pairwise$signif[1])
}

p.adj &lt;- p.adjust(p, method = &quot;BH&quot;)
p.table &lt;- cbind.data.frame(t(cbn), p=p, p.adj=p.adj)</code></pre>
<div id="htmlwidget-5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5">{"x":{"filter":"none","data":[["gut","gut","gut","left palm","left palm","right palm"],["left palm","right palm","tongue","right palm","tongue","tongue"],[0.001,0.001,0.001,0.765,0.001,0.001],[0.0012,0.0012,0.0012,0.765,0.0012,0.0012]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>p<\/th>\n      <th>p.adj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The NMDS and ANOSIM result were similar to that from PCoA and ADONIS.</p>
</div>
</div>
<div id="abundance-bar-plot" class="section level2">
<h2>Abundance bar plot</h2>
<p>Here the demos use un-rarefied table to show all detected tags.</p>
<ul>
<li>Phylum</li>
</ul>
<pre class="r"><code>ps.rel = transform_sample_counts(ps, function(x) x/sum(x)*100)
# agglomerate taxa
glom &lt;- tax_glom(ps.rel, taxrank = &#39;Phylum&#39;, NArm = FALSE)
ps.melt &lt;- psmelt(glom)
# change to character for easy-adjusted level
ps.melt$Phylum &lt;- as.character(ps.melt$Phylum)

ps.melt &lt;- ps.melt %&gt;%
  group_by(body.site, Phylum) %&gt;%
  mutate(median=median(Abundance))
# select group median &gt; 1
keep &lt;- unique(ps.melt$Phylum[ps.melt$median &gt; 1])
ps.melt$Phylum[!(ps.melt$Phylum %in% keep)] &lt;- &quot;&lt; 1%&quot;
#to get the same rows together
ps.melt_sum &lt;- ps.melt %&gt;%
  group_by(Sample,body.site,Phylum) %&gt;%
  summarise(Abundance=sum(Abundance))

ggplot(ps.melt_sum, aes(x = Sample, y = Abundance, fill = Phylum)) + 
  geom_bar(stat = &quot;identity&quot;, aes(fill=Phylum)) + 
  labs(x=&quot;&quot;, y=&quot;%&quot;) +
  facet_wrap(~body.site, scales= &quot;free_x&quot;, nrow=1) +
  theme_classic() + 
  theme(strip.background = element_blank(), 
        axis.text.x.bottom = element_text(angle = -90))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" width="672" />
<code>&lt; 1%</code> indicates rare taxa in each group, with median relative abundance &lt; 1%.</p>
<ul>
<li>Genus</li>
</ul>
<pre class="r"><code>ps.rel = transform_sample_counts(ps, function(x) x/sum(x)*100)
# agglomerate taxa
glom &lt;- tax_glom(ps.rel, taxrank = &#39;Genus&#39;, NArm = FALSE)
ps.melt &lt;- psmelt(glom)
# change to character for easy-adjusted level
ps.melt$Genus &lt;- as.character(ps.melt$Genus)

ps.melt &lt;- ps.melt %&gt;%
  group_by(body.site, Genus) %&gt;%
  mutate(median=median(Abundance))
# select group mean &gt; 1
keep &lt;- unique(ps.melt$Genus[ps.melt$median &gt; 2.5])
ps.melt$Genus[!(ps.melt$Genus %in% keep)] &lt;- &quot;&lt; 2.5%&quot;
#to get the same rows together
ps.melt_sum &lt;- ps.melt %&gt;%
  group_by(Sample,body.site,Genus) %&gt;%
  summarise(Abundance=sum(Abundance))

ggplot(ps.melt_sum, aes(x = Sample, y = Abundance, fill = Genus)) + 
  geom_bar(stat = &quot;identity&quot;, aes(fill=Genus)) + 
  labs(x=&quot;&quot;, y=&quot;%&quot;) +
  facet_wrap(~body.site, scales= &quot;free_x&quot;, nrow=1) +
  theme_classic() + 
  theme(legend.position = &quot;right&quot;, 
        strip.background = element_blank(), 
        axis.text.x.bottom = element_text(angle = -90))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" width="672" />
<code>&lt; 2.5%</code> indicates rare taxa in each group, with median relative abundance &lt; 2.5%.</p>
</div>
<div id="differential-abundance-analysis" class="section level2">
<h2>Differential abundance analysis</h2>
<p>Differential abundance analysis allows you to identify differentially abundant taxa between groups. There‚Äôs many methods, here two commonly used ones are given as examples. Features are collapsed at the species-level prior to the calculation.</p>
<pre class="r"><code>sample_data(ps)$body.site &lt;- as.factor(sample_data(ps)$body.site) # change to factor for DESeq2
ps.taxa &lt;- tax_glom(ps, taxrank = &#39;Species&#39;, NArm = FALSE)</code></pre>
<p>Let‚Äôs see what features are enriched differentially between tongue and gut.</p>
<div id="deseq2" class="section level3">
<h3>DESeq2</h3>
<p>DESeq2 is a software designed for RNA-seq, but also used in <a href="https://joey711.github.io/phyloseq-extensions/DESeq2.html">microbiome analysis</a>, and the detailed use of DESeq2 can be found <a href="http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#variations-to-the-standard-workflow">here</a>. However, you‚Äôre usually troubled by the ‚Äúzero‚Äù issues in microbiome analysis. A pseudo count is added to avoid the issues of logarithm transformation.</p>
<pre class="r"><code>ps.taxa.pse &lt;- ps.taxa
otu_table(ps.taxa.pse) &lt;- otu_table(ps.taxa) + 1
# pairwise comparison between gut and tongue
ps.taxa.pse.sub &lt;- subset_samples(ps.taxa.pse, body.site %in% c(&quot;gut&quot;, &quot;tongue&quot;))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ body.site)
ds = DESeq(ds, test=&quot;Wald&quot;, fitType=&quot;parametric&quot;)
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:20, ]) # sort by the padj, and select bottom 20 with lowest p.adj values
ps.taxa.rel &lt;- transform_sample_counts(ps, function(x) x/sum(x)*100)
ps.taxa.rel.sig &lt;- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig &lt;- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)</code></pre>
<p>Visualize these biomarkers in heatmap using R package <a href="https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html">ComplexHeatmap</a>, which is a improved package on the basis of pheatmap. A detailed reference book about ComplexHeatmap is <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/">here</a>. I like it because of its flexibility relative to built-in heatmap(), gplots::heatmap.2(), pheatmap::pheatmap() and heatmap3::heatmap(). However, the mentioned ones can also be adopted given the same theory of heatmap. The added function <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/integrate-with-other-packages.html#pheatmap">ComplexHeatmap::pheatmap</a> inherited most settings of pheatmap, so I adopt it to make code easily understood.</p>
<p>To make <code>pheatmap</code> specfic, the package is specified as ComplexHeatmap::pheatmap</p>
<pre class="r"><code>matrix &lt;- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))
rownames(matrix) &lt;- as.character(tax_table(ps.taxa.rel.sig)[, &quot;Species&quot;]) # use species name as rownames
metadata_sub &lt;- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Subject = as.factor(metadata_sub$subject), 
    `Body site` = as.factor(metadata_sub$body.site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps.taxa.rel.sig)[, &quot;Phylum&quot;])
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), &quot;Paired&quot;)
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Subject = c(`subject-1` = &quot;red&quot;, `subject-2` = &quot;blue&quot;),
    `Body site` = c(gut = &quot;purple&quot;, tongue = &quot;yellow&quot;),
    Phylum = phylum_col
)

ComplexHeatmap::pheatmap(matrix, scale= &quot;row&quot;, annotation_col = annotation_col, annotation_row = annotation_row, 
                         annotation_colors = ann_colors)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
</div>
<div id="ancom-bc" class="section level3">
<h3>ANCOM-BC</h3>
<p>Here I will introduce another statistical method specially designed for Microbiome data. I like its theory behind - sequencing is a process of sampling. For a microbial community under adequate sequencing, the ratio of two specific taxa should be theoretically the ‚Äúsame‚Äù between their profiled relative abundances and the absolute abundance. The theory can be found in their <a href="https://www.nature.com/articles/s41467-020-17041-7">published paper</a>. ANCOM is one recommended method by QIIME 2 and similar theory is also adopted in another QIIME 2 plugin- <a href="https://docs.qiime2.org/2020.11/tutorials/gneiss/">Geneiss</a>. ANCOM is originally written in R and hosted in NIH, but the link expired now. The <a href="https://docs.qiime2.org/2020.11/plugins/available/composition/">q2-compositon</a> plugin is one accessible version to my knowledge. In that QIIME has no R API, I recommend to use improved ANCOM version e.g.¬†<a href="https://github.com/FrederickHuangLin/ANCOM">ANCOM 2</a> and <a href="https://github.com/FrederickHuangLin/ANCOMBC">ANCOM-BC</a> if you only eat R code. These two have not been included in QIIME 2 and maintained by the lab members of the original ANCOM paper. The key differences between ANCOM 2 and ANCOM are how they treat <em>zeros</em> and introduced process of repeated data, and more can be found in the <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5682008/">paper</a>. Considering the structure of code, ANCOM 2 is more like a wrapper function of ANCOM, especially relative to ANCOM-BC. ANCOM-BC inherited the methodology of preprocessing <em>zeros</em> in ANCOM but estimated the sampling bias by linear regression. Besides, it provides <em>p</em> values and according to the author, it is blazingly fast while controlling the FDR and maintaining adequate power as ANCOM. ANCOM-BC is maintained at <a href="http://www.bioconductor.org/packages/release/bioc/html/ANCOMBC.html">bioconductor</a>, and a vignette is <a href="http://www.bioconductor.org/packages/release/bioc/vignettes/ANCOMBC/inst/doc/ANCOMBC.html">here</a>. It‚Äôs worth noting that ANCOM-BC is in development and now (Jan 2021) <a href="https://github.com/FrederickHuangLin/ANCOMBC/issues/5">only support testing for co-variates and global test</a>.</p>
<p>So we adopt ANCOM-BC to repeat the test above. And here it takes <em>gut</em> label as a reference to other <em>body site</em> groups.</p>
<pre class="r"><code># pairwise comparison between gut and tongue
ps.taxa.sub &lt;- subset_samples(ps.taxa, body.site %in% c(&quot;gut&quot;, &quot;tongue&quot;))
# ancombc
out &lt;- ancombc(phyloseq = ps.taxa.sub, formula = &quot;body.site&quot;, 
              p_adj_method = &quot;holm&quot;, zero_cut = 0.90, lib_cut = 1000, 
              group = &quot;body.site&quot;, struc_zero = TRUE, neg_lb = TRUE, tol = 1e-5, 
              max_iter = 100, conserve = TRUE, alpha = 0.05, global = TRUE)
res &lt;- out$res
# we take out the selected markers from &quot;body.sitetongue&quot; and select the bottom 20 with lowest p values
res.or_p &lt;- rownames(res$q_val[,&quot;body.sitetongue&quot;])[base::order(res$q_val[,&quot;body.sitetongue&quot;])]
taxa_sig &lt;- res.or_p[1:20]
ps.taxa.rel.sig &lt;- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples, inherit grouping information from the previous DESeq2 analysis 
ps.taxa.rel.sig &lt;- prune_samples(colnames(otu_table(ps.taxa.sub)), ps.taxa.rel.sig)</code></pre>
<p>Repeat heatmap script for the ANCOM result</p>
<pre class="r"><code>matrix &lt;- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))
rownames(matrix) &lt;- as.character(tax_table(ps.taxa.rel.sig)[, &quot;Species&quot;]) # use species name as rownames
metadata_sub &lt;- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Subject = as.factor(metadata_sub$subject), 
    `Body site` = as.factor(metadata_sub$body.site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps.taxa.rel.sig)[, &quot;Phylum&quot;])
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), &quot;Paired&quot;)
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Subject = c(`subject-1` = &quot;red&quot;, `subject-2` = &quot;blue&quot;),
    `Body site` = c(`gut` = &quot;purple&quot;, tongue = &quot;yellow&quot;),
    Phylum = phylum_col
)
ComplexHeatmap::pheatmap(matrix, scale= &quot;row&quot;, annotation_col = annotation_col, annotation_row = annotation_row, 
                         annotation_colors = ann_colors)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>The <em>mini</em>-tour shall end here. In that you know how to import the microbiome data in R, you can continue exploring your data according to diverse tutorials including <a href="https://joey711.github.io/phyloseq/">phyloseq</a> from U.S., <a href="https://madsalbertsen.github.io/ampvis2/articles/ampvis2.html">ampvis2</a> from Denmark, and <a href="https://yulab-smu.top/MicrobiotaProcessWorkshop/articles/MicrobiotaProcessWorkshop.html">MicrobiotaProcess</a> from China.</p>
<p>If you want a GUI software for your microbiome analysis, you may like <a href="https://www.microbiomeanalyst.ca/">microbiomeanalyst</a>, which was recently published on <a href="https://www.nature.com/articles/s41596-019-0264-1">Nature protocol</a>. I haven‚Äôt tried it in that I hate mouse clicking.üò±</p>
</div>
</div>
